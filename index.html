<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LICUIS ULTRA ADMIN</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0C1523;
            --bg-secondary: #1A212F;
            --bg-tertiary: #273142;
            --text-primary: #E2E8F0;
            --text-secondary: #94A3B8;
            --accent-blue: #4D77FF;
            --accent-teal: #00BFA6;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
        }

        body.dark-theme {
            font-family: 'Poppins', Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* General Layout */
        .sidebar {
            background-color: var(--bg-secondary);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            transform: translateX(-100%);
        }

        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
                position: static;
            }
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .main-content {
            flex-grow: 1;
            background-color: var(--bg-primary);
        }

        @media (min-width: 768px) {
            .main-content {
                padding-left: 288px;
            }
        }

        .sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 60;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3rem;
            height: 3rem;
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sidebar-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-secondary);
            transition: color 0.3s;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem 0;
            border-radius: 0.5rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .sidebar-link:hover,
        .sidebar-link.active {
            background-color: rgba(77, 119, 255, 0.1);
            color: var(--accent-blue);
            transform: translateX(5px);
        }

        .card {
            background-color: var(--bg-secondary);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            padding: 2rem;
        }

        .card-title {
            color: var(--accent-blue);
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
        }

        .card-title .icon {
            color: var(--accent-teal);
            margin-right: 0.75rem;
        }

        /* Form Elements */
        .input-group label {
            color: var(--text-secondary);
            font-weight: 500;
            display: block;
            margin-bottom: 0.5rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper .icon,
        .input-group .icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .search-input,
        .input-wrapper input,
        .input-group select {
            background-color: var(--bg-tertiary);
            border: 1px solid transparent;
            color: var(--text-primary);
            transition: border-color 0.3s, box-shadow 0.3s;
            padding-left: 2.5rem;
        }

        .search-input:focus,
        .input-wrapper input:focus,
        .input-group select:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(77, 119, 255, 0.3);
            outline: none;
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--accent-teal);
            color: var(--bg-primary);
            transition: all 0.3s;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
        }

        .btn-primary:hover {
            background-color: #008f7f;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #F59E0B;
            color: var(--bg-primary);
            transition: all 0.3s;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
        }

        .btn-secondary:hover {
            background-color: #d88a0e;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
            transition: all 0.3s;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
        }

        .btn-danger:hover {
            background-color: #d13a3a;
        }

        /* Specific Components */
        .key-box,
        .history-item-card {
            background-color: var(--bg-tertiary);
            border: 1px solid rgba(77, 119, 255, 0.15);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .key-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.3);
        }

        .status-active,
        .valid {
            color: var(--success);
        }

        .status-inactive,
        .expired {
            color: var(--danger);
        }

        .status-frozen {
            color: var(--warning);
        }

        .device-bound {
            color: var(--accent-blue);
        }

        .device-unbound {
            color: var(--text-secondary);
        }

        .modal {
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            border: 1px solid rgba(77, 119, 255, 0.2);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            color: var(--text-primary);
            border-radius: 1rem;
        }

        .close-button {
            color: var(--text-secondary);
            font-size: 1.5rem;
        }

        .history-item-card .action-type {
            color: var(--accent-blue);
            font-weight: 600;
        }

        .history-item-card pre {
            background-color: var(--bg-tertiary);
            border: 1px solid rgba(77, 119, 255, 0.1);
            color: var(--text-secondary);
            border-radius: 0.5rem;
            padding: 1rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Custom Switch for Toggles */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-blue);
        }

        input:focus+.slider {
            box-shadow: 0 0 1px var(--accent-blue);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body class="dark-theme flex min-h-screen">
    <div id="sidebarToggle" class="sidebar-toggle md:hidden">
        <i class="fas fa-bars"></i>
    </div>

    <div id="sidebar" class="sidebar w-72 p-6 flex flex-col md:static">
        <span class="sidebar-close-btn md:hidden" id="sidebarCloseBtn"><i class="fas fa-times"></i></span>
        <div class="happi-admin-title text-2xl font-bold text-center mb-8">LICUIS ULTRA ADMIN</div>
        <nav class="flex-grow">
            <a href="#" class="sidebar-link active" data-section="keyGeneratorSection">
                <i class="fas fa-key w-6 mr-3"></i> Create a Key
            </a>
            <a href="#" class="sidebar-link" data-section="manageHistorySection">
                <i class="fas fa-history w-6 mr-3"></i> Manage History
            </a>
            <a href="#" class="sidebar-link" data-section="manageSettingsSection">
                <i class="fas fa-cogs w-6 mr-3"></i> Manage Settings
            </a>
        </nav>
        <div class="text-xs text-center text-gray-400 mt-4"></div>
    </div>

    <div class="main-content p-8 pt-20 md:pt-8 overflow-y-auto">
        <h1 class="text-3xl font-bold mb-8" style="color: var(--text-primary);">
            <span id="currentSectionTitle">Key Generator</span>
        </h1>

        <div id="keyGeneratorSection" class="content-section">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="card lg:col-span-1">
                    <h2 class="card-title">
                        <i class="fas fa-plus-circle icon"></i>Create New Access Key
                    </h2>
                    <div id="key-creation" class="space-y-6">
                        <div>
                            <div class="input-group">
                                <label for="key"><i class="fas fa-fingerprint mr-2"></i>KEY</label>
                                <div class="input-wrapper">
                                    <input type="text" id="key" placeholder="Enter key"
                                        class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="input-group">
                                <label for="create_deviceId"><i class="fas fa-desktop mr-2"></i>Device ID (optional)</label>
                                <div class="input-wrapper">
                                    <input type="text" id="create_deviceId" placeholder="Enter Device ID (e.g., USER-PC-001)"
                                        class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="input-group">
                                    <label for="durationValue"><i class="fas fa-hourglass-half mr-2"></i>Duration Value</label>
                                    <input type="number" id="durationValue" placeholder="Duration value" value="1" min="1"
                                        class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                                </div>
                            </div>
                            <div>
                                <div class="input-group">
                                    <label for="durationUnit"><i class="fas fa-calendar-day mr-2"></i>Duration Unit</label>
                                    <select id="durationUnit"
                                        class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                                        <option value="minutes">Minutes</option>
                                        <option value="days" selected>Days</option>
                                        <option value="months">Months</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button onclick="createKey()" class="w-full btn-primary">
                            <i class="fas fa-save mr-2"></i>Create Key
                        </button>
                        <button onclick="generateRandomKey()" class="w-full btn-secondary">
                            <i class="fas fa-dice mr-2"></i>Generate Random Key
                        </button>
                    </div>
                </div>

                <div class="card lg:col-span-2">
                    <h2 class="card-title flex items-center justify-between">
                        <span><i class="fas fa-list-alt icon"></i>ACCESS KEYS HISTORY</span>
                        <span id="keyCount" class="text-lg text-gray-600 font-normal">TOTAL KEYS: 0</span>
                    </h2>
                    <input type="text" id="search" placeholder="Search keys..." onkeyup="renderAccessKeys()"
                        class="w-full px-4 py-3 rounded-md focus:outline-none focus:ring-2 search-input mb-4">
                    <div id="key-list-container" class="overflow-y-auto max-h-96">
                        <div id="keys" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="manageHistorySection" class="content-section hidden">
            <div class="card">
                <div class="card-title"><span class="icon fas fa-history"></span> Action History</div>
                <input type="text" id="historySearch" placeholder="Search history..." onkeyup="renderHistory()"
                    class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input mb-4">
                <div id="historyListContainer" class="space-y-4"></div>
            </div>
        </div>

        <div id="manageSettingsSection" class="content-section hidden">
            <div class="card max-w-2xl mx-auto">
                <div class="card-title"><span class="icon fas fa-cogs"></span> Web Settings</div>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">System Modes</label>
                        <div class="flex items-center justify-between py-2">
                            <span>Maintenance Mode</span>
                            <label class="switch">
                                <input type="checkbox" id="maintenanceModeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="flex items-center justify-between py-2">
                            <span>Web Off (404 Mode)</span>
                            <label class="switch">
                                <input type="checkbox" id="webOffToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Redirect Settings</label>
                        <div class="input-wrapper">
                            <i class="fas fa-external-link-alt icon"></i>
                            <input type="text" id="redirectUrl" placeholder="Redirect URL"
                                class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                        </div>
                    </div>
                </div>
                <button id="saveSettingsBtn" class="btn-primary w-full mt-6"><span class="icon fas fa-save"></span> Save
                    Changes</button>
                <p id="settingsMessage" class="text-sm mt-4 text-center"></p>
            </div>
        </div>
    </div>

    <div id="customModal" class="fixed inset-0 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content text-center p-8 max-w-sm w-full mx-auto">
            <span class="absolute top-4 right-4 cursor-pointer close-button" onclick="closeCustomModal()">&times;</span>
            <div id="modalIcon" class="text-4xl mb-4"></div>
            <h3 id="modalTitle" class="text-xl font-bold mb-2"></h3>
            <p id="modalMessage" class="text-gray-400 mb-4"></p>
            <div id="modalActions" class="flex justify-center space-x-4">
                <button id="modalConfirmBtn"
                    class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 hidden">Confirm</button>
                <button id="modalCloseBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Close</button>
            </div>
        </div>
    </div>

    <div id="editAccessKeyModal" class="fixed inset-0 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content p-8 max-w-lg w-full mx-auto">
            <span class="absolute top-4 right-4 cursor-pointer close-button"
                onclick="closeEditAccessKeyModal()">&times;</span>
            <h2 class="text-xl font-semibold mb-4">Edit Access Key</h2>
            <form id="editAccessKeyForm" class="space-y-4">
                <input type="hidden" id="edit_key_original_name">
                <div>
                    <label for="edit_key_name" class="block text-sm font-medium text-gray-400 mb-1">Key Name</label>
                    <input type="text" id="edit_key_name" name="edit_key_name" required readonly
                        class="w-full px-4 py-2 rounded-md search-input bg-gray-600 cursor-not-allowed">
                </div>
                <div>
                    <label for="edit_key_deviceId" class="block text-sm font-medium text-gray-400 mb-1">Device ID (leave blank for UNBOUND)</label>
                    <input type="text" id="edit_key_deviceId" name="edit_key_deviceId"
                        class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit_durationValue" class="block text-sm font-medium text-gray-400 mb-1">Duration
                            Value</label>
                        <input type="number" id="edit_durationValue" name="edit_durationValue" min="1" value="1" required
                            class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                    </div>
                    <div>
                        <label for="edit_durationUnit" class="block text-sm font-medium text-gray-400 mb-1">Duration
                            Unit</label>
                        <select id="edit_durationUnit" name="edit_durationUnit" required
                            class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                            <option value="minutes">Minutes</option>
                            <option value="days">Days</option>
                            <option value="months">Months</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeEditAccessKeyModal()"
                        class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Save
                        Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editResellerModal" class="fixed inset-0 flex items-center justify-center p-4 modal hidden">
        <div class="modal-content p-8 max-w-lg w-full mx-auto">
            <span class="absolute top-4 right-4 cursor-pointer close-button"
                onclick="closeEditResellerModal()">&times;</span>
            <h2 class="text-xl font-semibold mb-4">Edit Reseller</h2>
            <form id="editResellerForm" class="space-y-4">
                <input type="hidden" id="edit_reseller_id">
                <div>
                    <label for="edit_reseller_username" class="block text-sm font-medium text-gray-400 mb-1">Username</label>
                    <input type="text" id="edit_reseller_username" name="edit_reseller_username" required
                        class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                </div>
                <div>
                    <label for="edit_reseller_password" class="block text-sm font-medium text-gray-400 mb-1">Password (Leave
                        blank to keep current)</label>
                    <input type="password" id="edit_reseller_password" name="edit_reseller_password"
                        class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                </div>
                <div>
                    <label for="edit_reseller_deviceId" class="block text-sm font-medium text-gray-400 mb-1">Device ID (Leave
                        blank for UNBOUND)</label>
                    <input type="text" id="edit_reseller_deviceId" name="edit_reseller_deviceId"
                        class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit_reseller_durationValue" class="block text-sm font-medium text-gray-400 mb-1">Add
                            Duration</label>
                        <input type="number" id="edit_reseller_durationValue" name="edit_reseller_durationValue" min="1"
                            value="1" required
                            class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                    </div>
                    <div>
                        <label for="edit_reseller_durationUnit" class="block text-sm font-medium text-gray-400 mb-1">Duration
                            Unit</label>
                        <select id="edit_reseller_durationUnit" name="edit_reseller_durationUnit" required
                            class="w-full px-4 py-2 rounded-md focus:outline-none focus:ring-2 search-input">
                            <option value="minutes">Minutes</option>
                            <option value="days">Days</option>
                            <option value="months">Months</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeEditResellerModal()"
                        class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Save
                        Changes</button>
                </div>
            </form>
        </div>
    </div>


<script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, get, child, update, remove } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js';

        // --- Firebase Configuration (REQUIRED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDO8hiCtSLKBE-sY2oq3YCcCRMsOyYQe88",
            authDomain: "backdoor-3da3d.firebaseapp.com",
            databaseURL: "https://licuis-ultra-default-rtdb.firebaseio.com",
            projectId: "licuis-ultra",
            storageBucket: "licuis-ultra.firebasestorage.app",
            messagingSenderId: "296618804855",
            appId: "1:97102516449:android:3d233caae759dbdfce27a0"
        };
        // End of Firebase Configuration

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const accessKeysRef = ref(db, 'accessKeys');
        const settingsRef = ref(db, 'settings');
        const historyRef = ref(db, 'history');

        // --- Custom Modal Functions ---
        const customModal = document.getElementById('customModal');
        const modalIcon = document.getElementById('modalIcon');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        function openCustomModal(type, title, message, onConfirm = null) {
            modalIcon.className = 'text-4xl mb-4';
            if (type === 'success') {
                modalIcon.classList.add('text-green-500');
                modalIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            } else if (type === 'error') {
                modalIcon.classList.add('text-red-500');
                modalIcon.innerHTML = '<i class="fas fa-times-circle"></i>';
            } else if (type === 'info') {
                modalIcon.classList.add('text-blue-500');
                modalIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            } else if (type === 'confirm') {
                modalIcon.classList.add('text-yellow-500');
                modalIcon.innerHTML = '<i class="fas fa-question-circle"></i>';
            }

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;

            if (onConfirm) {
                modalConfirmBtn.style.display = 'inline-block';
                modalConfirmBtn.onclick = () => {
                    onConfirm();
                    closeCustomModal();
                };
                modalCloseBtn.textContent = 'Cancel';
            } else {
                modalConfirmBtn.style.display = 'none';
                modalCloseBtn.textContent = 'Close';
            }
            modalCloseBtn.onclick = closeCustomModal;
            customModal.style.display = 'flex';
        }

        function closeCustomModal() {
            customModal.style.display = 'none';
            modalConfirmBtn.onclick = null;
            modalCloseBtn.onclick = null;
        }

        // --- Utility Functions ---

        // Function to format time left (for expiry)
        function formatTimeLeft(ms) {
            const secs = Math.floor(ms / 1000);
            if (secs <= 0) return 'EXPIRED';

            const secondsInMinute = 60;
            const secondsInHour = 60 * secondsInMinute;
            const secondsInDay = 24 * secondsInHour;
            const secondsInMonth = 30 * secondsInDay;

            const months = Math.floor(secs / secondsInMonth);
            const remainingSecsAfterMonths = secs % secondsInMonth;
            const days = Math.floor(remainingSecsAfterMonths / secondsInDay);
            const remainingSecsAfterDays = remainingSecsAfterMonths % secondsInDay;
            const hours = Math.floor(remainingSecsAfterDays / secondsInHour);
            const remainingSecsAfterHours = remainingSecsAfterDays % secondsInHour;
            const minutes = Math.floor(remainingSecsAfterHours / secondsInMinute);
            const seconds = remainingSecsAfterHours % secondsInMinute;

            let timeLeftStr = "";
            if (months > 0) timeLeftStr += `${months}M `;
            if (days > 0) timeLeftStr += `${days}D `;
            if (hours > 0) timeLeftStr += `${hours}H `;
            if (minutes > 0) timeLeftStr += `${minutes}M `;
            if (seconds > 0 || (months === 0 && days === 0 && hours === 0 && minutes === 0)) timeLeftStr += `${seconds}S`;

            return timeLeftStr.trim();
        }

        // Function to calculate expiry timestamp for Access Keys, handling months accurately
        function calculateExpiry(durationValue, durationUnit, currentTimestamp = Date.now()) {
            let expiryDate = new Date(currentTimestamp);

            if (durationUnit === 'minutes') {
                expiryDate.setMinutes(expiryDate.getMinutes() + durationValue);
            } else if (durationUnit === 'days') {
                expiryDate.setDate(expiryDate.getDate() + durationValue);
            } else if (durationUnit === 'months') {
                expiryDate.setMonth(expiryDate.getMonth() + durationValue);
            } else {
                return null;
            }
            return expiryDate.getTime();
        }

        // Function to log actions to history
        async function logAction(actionType, details) {
            try {
                await push(historyRef, {
                    timestamp: new Date().toISOString(),
                    action: actionType,
                    details: details
                });
            } catch (error) {
                console.error("Error logging action to history:", error);
            }
        }

        // Universal Confirmation/Action Wrapper
        window.confirmAction = function (type, title, message, callback) {
            openCustomModal(type, title, message, callback);
        }

        // --- Access Key Management Functions ---

        window.createKey = async function () {
            const key = document.getElementById('key').value.trim();
            const deviceId = document.getElementById('create_deviceId').value.trim() || null;
            const durationValue = parseInt(document.getElementById('durationValue').value);
            const durationUnit = document.getElementById('durationUnit').value;

            if (!key || !durationValue) {
                openCustomModal('error', 'Input Error', "Please fill in 'Key' and 'Duration Value'.");
                return;
            }

            try {
                const snapshot = await get(child(accessKeysRef, key));
                if (snapshot.exists()) {
                    openCustomModal('info', 'Creation Failed', `Access key "${key}" already exists. Please choose a different key.`);
                    return;
                }

                const expiry = calculateExpiry(durationValue, durationUnit);

                await set(child(accessKeysRef, key), {
                    expiry: expiry,
                    deviceId: deviceId,
                    active: true,
                    frozen: false
                });

                document.getElementById('key').value = "";
                document.getElementById('create_deviceId').value = "";
                document.getElementById('durationValue').value = "1";
                document.getElementById('durationUnit').value = "days";
                openCustomModal('success', 'Key Created', `Access key "${key}" created successfully!`);
                renderAccessKeys();
                await logAction('Access Key Created', { key: key, deviceId: deviceId, durationValue: durationValue, durationUnit: durationUnit, expiry: new Date(expiry).toISOString(), active: true });
            } catch (error) {
                console.error("Error creating key:", error);
                openCustomModal('error', 'Creation Failed', 'Failed to create key: ' + error.message);
            }
        };

        window.generateRandomKey = function () {
            const part = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('key').value = "LICUIS-" + part;
        };

        window.renderAccessKeys = function () {
            const query = document.getElementById('search').value.toLowerCase();
            get(accessKeysRef).then(snapshot => {
                const container = document.getElementById('keys');
                const keyCount = document.getElementById('keyCount');
                container.innerHTML = '';
                let total = 0;
                if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">No access keys found.</div>';
                    keyCount.innerText = `TOTAL KEYS: 0`;
                    return;
                }
                snapshot.forEach(childSnapshot => {
                    const k = childSnapshot.key;
                    const data = childSnapshot.val();
                    if (!k.toLowerCase().includes(query)) return;

                    const now = Date.now();
                    const expired = data.expiry < now;
                    const timeLeft = expired ? 'EXPIRED' : formatTimeLeft(data.expiry - now);
                    const isActive = data.active !== false;
                    const isFrozen = data.frozen === true;

                    const deviceIdText = data.deviceId ? data.deviceId : 'UNBOUND';
                    const deviceStatusClass = data.deviceId ? 'device-bound' : 'device-unbound';

                    let statusClass, statusText;
                    if (isFrozen) {
                        statusClass = 'status-frozen';
                        statusText = 'FROZEN';
                    } else if (isActive) {
                        statusClass = 'status-active';
                        statusText = 'ACTIVE';
                    } else {
                        statusClass = 'status-inactive';
                        statusText = 'INACTIVE';
                    }

                    total++;
                    container.innerHTML += `
                        <div class="key-box space-y-2">
                            <div class="flex items-center justify-between flex-wrap">
                                <b class="text-lg text-gray-900">${k}</b>
                                <div class="flex space-x-2 mt-2 md:mt-0">
                                    <button onclick="editAccessKey('${k}', '${data.deviceId || ''}')"
                                        class="text-blue-600 hover:text-blue-900" title="Edit Key">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="confirmAction('confirm', '${isFrozen ? 'Unfreeze' : 'Freeze'} Key', 'Are you sure you want to ${isFrozen ? 'unfreeze' : 'freeze'} key \\'${k}\\'?', () => toggleAccessKeyFrozen('${k}', ${isFrozen}))"
                                        class="text-yellow-600 hover:text-yellow-900" title="${isFrozen ? 'Unfreeze' : 'Freeze'} Key">
                                        <i class="fas fa-snowflake"></i>
                                    </button>
                                    <button onclick="confirmAction('confirm', '${isActive ? 'Deactivate' : 'Activate'} Key', 'Are you sure you want to ${isActive ? 'deactivate' : 'activate'} key \\'${k}\\'?', () => toggleAccessKeyStatus('${k}', ${isActive}))"
                                        class="${isActive ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'}" title="${isActive ? 'Deactivate' : 'Activate'} Key">
                                        <i class="fas ${isActive ? 'fa-power-off' : 'fa-play-circle'}"></i>
                                    </button>
                                    <button onclick="confirmAction('confirm', 'Delete Key', 'Are you sure you want to delete key \\'${k}\\'? This action cannot be undone.', () => deleteKey('${k}'))"
                                        class="text-red-500 hover:text-red-700" title="Delete Key">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <div>STATUS: <span class="${statusClass} font-semibold">${statusText}</span></div>
                                <div>EXPIRES IN: <span class="${expired ? 'expired' : 'valid'} font-semibold">${timeLeft}</span></div>
                            </div>
                            <div class="text-sm">DEVICE: <span class="${deviceStatusClass} font-semibold">${deviceIdText}</span></div>
                            <div><small class="text-gray-500">Last updated: ${new Date(data.expiry).toLocaleString()}</small></div>
                        </div>
                    `;
                });
                keyCount.innerText = `TOTAL KEYS: ${total}`;
            }).catch(error => {
                console.error("Error rendering access keys:", error);
                openCustomModal('error', 'Key List Error', 'Failed to load access keys: ' + error.message);
            });
        }

        window.deleteKey = async function (k) {
            try {
                await remove(child(accessKeysRef, k));
                openCustomModal('success', 'Key Deleted', `Access key "${k}" deleted successfully.`);
                renderAccessKeys();
                await logAction('Access Key Deleted', { key: k });
            } catch (error) {
                console.error("Error deleting key:", error);
                openCustomModal('error', 'Deletion Failed', 'Failed to delete key: ' + error.message);
            }
        };

        const editAccessKeyModal = document.getElementById('editAccessKeyModal');
        const editAccessKeyForm = document.getElementById('editAccessKeyForm');
        const editKeyOriginalName = document.getElementById('edit_key_original_name');
        const editKeyName = document.getElementById('edit_key_name');
        const editKeyDeviceId = document.getElementById('edit_key_deviceId');
        const editDurationValue = document.getElementById('edit_durationValue');
        const editDurationUnit = document.getElementById('edit_durationUnit');

        window.editAccessKey = function (keyName, deviceId) {
            editKeyOriginalName.value = keyName;
            editKeyName.value = keyName;
            editKeyDeviceId.value = deviceId || '';
            editDurationValue.value = 1;
            editDurationUnit.value = 'days';

            editAccessKeyModal.style.display = 'flex';
        }

        window.closeEditAccessKeyModal = function () {
            editAccessKeyModal.style.display = 'none';
            editAccessKeyForm.reset();
        }

        editAccessKeyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const originalKeyName = editKeyOriginalName.value;
            const newDeviceId = editKeyDeviceId.value.trim() || null;
            const newDurationValue = parseInt(editDurationValue.value);
            const newDurationUnit = editDurationUnit.value;

            if (!originalKeyName || !newDurationValue || !newDurationUnit) {
                openCustomModal('error', 'Input Error', 'Please fill in all required fields for editing.');
                return;
            }

            const currentKeySnapshot = await get(child(accessKeysRef, originalKeyName));
            let currentExpiry = Date.now();
            if (currentKeySnapshot.exists()) {
                currentExpiry = currentKeySnapshot.val().expiry;
            }

            const newExpiry = calculateExpiry(newDurationValue, newDurationUnit, currentExpiry);

            try {
                const updates = {
                    deviceId: newDeviceId,
                    expiry: newExpiry
                };

                await update(child(accessKeysRef, originalKeyName), updates);
                openCustomModal('success', 'Key Updated', `Access key "${originalKeyName}" updated successfully!`);
                closeEditAccessKeyModal();
                renderAccessKeys();
                await logAction('Access Key Edited', { key: originalKeyName, updatedFields: updates });
            } catch (error) {
                console.error("Error updating access key:", error);
                openCustomModal('error', 'Update Failed', 'Failed to update access key: ' + error.message);
            }
        });

        window.toggleAccessKeyStatus = async function (key, currentStatus) {
            const newStatus = !currentStatus;
            const actionText = newStatus ? 'activate' : 'deactivate';
            try {
                await update(child(accessKeysRef, key), { active: newStatus, frozen: false });
                openCustomModal('success', 'Status Changed', `Access key "${key}" ${actionText}d successfully.`);
                renderAccessKeys();
                await logAction(`Access Key ${newStatus ? 'Activated' : 'Deactivated'}`, { key: key, newStatus: newStatus });
            } catch (error) {
                console.error("Error toggling access key status:", error);
                openCustomModal('error', 'Status Change Failed', 'Failed to toggle access key status: ' + error.message);
            }
        };

        window.toggleAccessKeyFrozen = async function (key, isFrozen) {
            const newFrozenStatus = !isFrozen;
            const actionText = newFrozenStatus ? 'frozen' : 'unfrozen';
            try {
                await update(child(accessKeysRef, key), { frozen: newFrozenStatus, active: !newFrozenStatus });
                openCustomModal('success', 'Status Changed', `Access key "${key}" has been ${actionText} successfully.`);
                renderAccessKeys();
                await logAction(`Access Key ${newFrozenStatus ? 'Frozen' : 'Unfrozen'}`, { key: key, isFrozen: newFrozenStatus });
            } catch (error) {
                console.error("Error toggling access key frozen status:", error);
                openCustomModal('error', 'Status Change Failed', 'Failed to toggle access key frozen status: ' + error.message);
            }
        };

        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
        const body = document.body;

        function toggleSidebar() {
            sidebar.classList.toggle('active');
            body.classList.toggle('sidebar-open');
        }

        sidebarToggle.addEventListener('click', toggleSidebar);
        sidebarCloseBtn.addEventListener('click', toggleSidebar);

        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const contentSections = document.querySelectorAll('.content-section');
        const currentSectionTitle = document.getElementById('currentSectionTitle');

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = link.dataset.section;

                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                contentSections.forEach(section => section.classList.add('hidden'));

                document.getElementById(targetSectionId).classList.remove('hidden');

                currentSectionTitle.textContent = link.textContent.trim();

                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        const maintenanceModeToggle = document.getElementById('maintenanceModeToggle');
        const webOffToggle = document.getElementById('webOffToggle');
        const redirectUrlInput = document.getElementById('redirectUrl');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const settingsMessage = document.getElementById('settingsMessage');

        async function loadSettings() {
            try {
                const snapshot = await get(settingsRef);
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    maintenanceModeToggle.checked = settings.maintenanceMode || false;
                    webOffToggle.checked = settings.webOff || false;
                    redirectUrlInput.value = settings.redirectUrl || '';
                }
            } catch (error) {
                console.error("Error loading settings:", error);
                settingsMessage.className = 'message text-red-500';
                settingsMessage.textContent = 'Failed to load settings.';
            }
        }

        saveSettingsBtn.addEventListener('click', async () => {
            const settings = {
                maintenanceMode: maintenanceModeToggle.checked,
                webOff: webOffToggle.checked,
                redirectUrl: redirectUrlInput.value.trim()
            };

            try {
                await set(settingsRef, settings);
                settingsMessage.className = 'message text-green-500';
                settingsMessage.textContent = 'Settings saved successfully!';
                await logAction('Web Settings Updated', { settings: settings });
            } catch (error) {
                console.error("Error saving settings:", error);
                settingsMessage.className = 'message text-red-500';
                settingsMessage.textContent = 'Failed to save settings: ' + error.message;
            }
        });

        const historyListContainer = document.getElementById('historyListContainer');
        const historySearchInput = document.getElementById('historySearch');

        window.renderHistory = async function () {
            historyListContainer.innerHTML = '';
            const query = historySearchInput.value.toLowerCase();
            try {
                const snapshot = await get(historyRef);
                if (!snapshot.exists() || Object.keys(snapshot.val()).length === 0) {
                    historyListContainer.innerHTML = '<div class="text-center text-gray-500 py-4 col-span-full">No history entries found.</div>';
                    return;
                }
                const historyEntries = [];
                snapshot.forEach(childSnapshot => {
                    historyEntries.push(childSnapshot.val());
                });

                historyEntries.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());

                historyEntries.forEach(entry => {
                    const timestamp = new Date(entry.timestamp).toLocaleString();
                    const action = entry.action;
                    const details = JSON.stringify(entry.details, null, 2);

                    if (action.toLowerCase().includes(query) || details.toLowerCase().includes(query)) {
                        historyListContainer.innerHTML += `
                            <div class="history-item-card space-y-2">
                                <p class="text-sm"><span class="action-type">${action}</span></p>
                                <pre class="text-xs text-gray-700 whitespace-pre-wrap">${details}</pre>
                                <p class="timestamp text-xs text-gray-500">${timestamp}</p>
                            </div>
                        `;
                    }
                });

                if (historyListContainer.innerHTML === '') {
                    historyListContainer.innerHTML = '<div class="text-center text-gray-500 py-4 col-span-full">No matching history entries found.</div>';
                }

            } catch (error) {
                console.error("Error rendering history:", error);
                openCustomModal('error', 'History Error', 'Failed to load history: ' + error.message);
            }
        };

        // Initial render calls
        renderAccessKeys();
        loadSettings();
        renderHistory();

        // Fix for setInterval, should not use onValue for this
        // onValue(accessKeysRef, () => { renderAccessKeys() });

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                sidebarToggle.style.display = 'flex';
            }
        });

        // This is not needed and can cause performance issues if not handled carefully
        // setInterval(renderAccessKeys, 1000);
    </script>
</body>
</html>
